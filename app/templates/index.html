<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard: Macroeconomic & Company Data</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nouislider@14.6.3/distribute/nouislider.min.css">
    <script src="https://cdn.jsdelivr.net/npm/nouislider@14.6.3/distribute/nouislider.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
</head>
<body>
    <header>
        <h1>Financial Dashboard</h1>
        <p>Historical data with predictions for 2025-2026</p>
    </header>

    <div class="tabs">
        <button class="tab-button active" data-tab="macro-tab">Macroeconomic Indicators</button>
        <button class="tab-button" data-tab="company-tab">Company Metrics</button>
        <button class="tab-button" data-tab="upload-tab">Upload Data</button>
        <button class="tab-button" data-tab="chat-tab">Chat Assistant</button>
    </div>
    
    <!-- Chat Tab -->
    <div class="tab-content" id="chat-tab" style="display: none;">
        <div class="container">
            <div class="sidebar">
                <h2>Chat Assistant</h2>
                <div class="chat-info">
                    <p>Welcome to the Financial Insights Assistant! Ask questions about:</p>
                    <ul>
                        <li>Macroeconomic indicators and trends</li>
                        <li>Company metrics and performance</li>
                        <li>Correlations between economic factors and your business</li>
                        <li>Prediction reliability and future outlook</li>
                        <li>Model performance and feature importance</li>
                    </ul>
                    <div class="recent-topics">
                        <h3>Suggested Topics</h3>
                        <div class="topic-chips" id="topic-chips">
                            <button class="topic-chip">Revenue forecasts</button>
                            <button class="topic-chip">GDP correlation</button>
                            <button class="topic-chip">Model accuracy</button>
                            <button class="topic-chip">Market trends</button>
                            <button class="topic-chip">Risk factors</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="main-content chat-main-content">
                <div class="chat-header-controls">
                    <button id="clear-chat-btn">Clear Chat</button>
                    <div class="chat-view-options">
                        <span>View: </span>
                        <select id="chat-view-selector">
                            <option value="all">All Messages</option>
                            <option value="macro">Macroeconomic Focus</option>
                            <option value="company">Company Focus</option>
                            <option value="predictions">Predictions Focus</option>
                        </select>
                    </div>
                </div>
                
                <div class="tab-chat-messages" id="tab-chat-messages">
                    <div class="message system">
                        <div class="message-content">
                            <p>üëã Hello! I'm your Financial Insights Assistant. I can help you understand:</p>
                            <ul>
                                <li>The relationships between macroeconomic indicators and your company metrics</li>
                                <li>The predictions for 2025-2026 and their reliability</li>
                                <li>Key factors influencing your business performance</li>
                            </ul>
                            <p>What would you like to explore today?</p>
                        </div>
                    </div>
                </div>
                
                <div class="tab-chat-input-container">
                    <input type="text" id="tab-chat-input" placeholder="Ask anything about your financial data, predictions, or relationships...">
                    <button id="tab-send-chat-btn"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>
    </div>

    <!-- Macroeconomic Tab -->
    <div class="tab-content" id="macro-tab">
        <div class="container">
            <div class="sidebar">
                <h2>Select Indicator</h2>
                <div class="indicator-list">
                    {% for indicator in macro_indicators %}
                        <div class="indicator-item" data-indicator="{{ indicator }}">
                            {{ indicator.replace('_', ' ') }}
                        </div>
                    {% endfor %}
                </div>
                
                <div class="prediction-summary">
                    <h2>Prediction Summary</h2>
                    <div id="macro-summary-content" class="summary-content">
                        <p>Select an indicator to view its prediction summary</p>
                    </div>
                </div>
            </div>
            
            <div class="main-content">
                <div class="chart-container">
                    <canvas id="macroChart"></canvas>
                </div>
                
                <div class="info-panel">
                    <h2 id="current-macro-indicator">Select an indicator</h2>
                    <p id="macro-indicator-description"></p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Company Metrics Tab -->
    <div class="tab-content" id="company-tab" style="display: none;">
        <div class="container">
            <div class="sidebar">
                <h2>Select Company Metric</h2>
                <div class="indicator-list">
                    {% for metric in company_metrics %}
                        <div class="company-item" data-metric="{{ metric }}">
                            {{ metric.replace('_', ' ') }}
                        </div>
                    {% endfor %}
                </div>
                
                <div class="prediction-summary">
                    <h2>Prediction Summary</h2>
                    <div id="company-summary-content" class="summary-content">
                        <p>Select a metric to view its prediction summary</p>
                    </div>
                </div>
            </div>
            
            <div class="main-content">
                <div class="chart-container">
                    <canvas id="companyChart"></canvas>
                </div>
                
                <div class="info-panel">
                    <h2 id="current-company-metric">Select a metric</h2>
                    <p id="company-metric-description"></p>
                </div>
                
                <!-- Enhanced Model Performance Section with Multi-Model Support -->
                <div class="model-performance-section">
                    <button id="toggle-performance-btn" class="toggle-performance-btn">
                        <i class="fas fa-chart-line"></i> <span id="toggle-text">Show Model Performance</span>
                    </button>
                    
                    <div id="model-performance-container" class="model-performance-container hidden">
                        <h3>Model Performance & Comparison</h3>
                        <p class="model-description">Performance metrics and comparison across different ML models</p>
                        
                        <!-- Model Selection Controls -->
                        <div class="model-controls">
                            <div class="model-selector-group">
                                <label for="model-selector">Select Model:</label>
                                <select id="model-selector" class="model-selector">
                                    <option value="best">Best Model (Recommended)</option>
                                    <!-- Options will be populated dynamically -->
                                </select>
                                <span id="selected-model-badge" class="model-badge"></span>
                            </div>
                            
                            <div class="view-controls">
                                <button id="comparison-view-btn" class="view-btn active">Comparison View</button>
                                <button id="detailed-view-btn" class="view-btn">Detailed View</button>
                            </div>
                        </div>
                        
                        <!-- Model Comparison Dashboard -->
                        <div id="model-comparison-dashboard" class="comparison-dashboard">
                            <div class="comparison-grid">
                                <!-- Model Performance Comparison Chart -->
                                <div class="comparison-chart-container">
                                    <h4>Model Performance Comparison</h4>
                                    <p>R¬≤ Score comparison across all models</p>
                                    <div class="chart-wrapper">
                                        <canvas id="modelComparisonChart"></canvas>
                                    </div>
                                </div>
                                
                                <!-- Error Rate Comparison -->
                                <div class="error-comparison-container">
                                    <h4>Error Rate Comparison</h4>
                                    <p>Mean Absolute Percentage Error (MAPE) by model</p>
                                    <div class="chart-wrapper">
                                        <canvas id="errorComparisonChart"></canvas>
                                    </div>
                                </div>
                                
                                <!-- Model Ranking Table -->
                                <div class="ranking-table-container">
                                    <h4>Model Rankings</h4>
                                    <p>Ranked by composite performance score</p>
                                    <div class="ranking-table-wrapper">
                                        <table id="model-ranking-table" class="ranking-table">
                                            <thead>
                                                <tr>
                                                    <th>Rank</th>
                                                    <th>Model</th>
                                                    <th>R¬≤ Score</th>
                                                    <th>MAPE</th>
                                                    <th>Score</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <!-- Will be populated dynamically -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                
                                <!-- Best Model Summary -->
                                <div class="best-model-summary">
                                    <h4>Selected Model</h4>
                                    <div id="best-model-info" class="model-info-card">
                                        <div class="model-name">Loading...</div>
                                        <div class="model-description">Please select a metric</div>
                                        <div class="confidence-indicator">
                                            <span class="confidence-label">Confidence:</span>
                                            <span id="confidence-level" class="confidence-value">-</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Detailed Model Performance View -->
                        <div id="detailed-performance-view" class="detailed-performance" style="display: none;">
                            <div class="performance-grid">
                                <div class="performance-card">
                                    <div class="info-tooltip">
                                        <i class="fas fa-info-circle"></i>
                                        <span class="tooltip-text">R¬≤ measures how well the model explains the variance in the data (0-1, higher is better)</span>
                                    </div>
                                    <h4>Model Accuracy</h4>
                                    <div class="metric-value" id="model-r2">--</div>
                                    <div class="metric-label">R¬≤ Score</div>
                                    <div class="metric-assessment" id="r2-assessment"></div>
                                </div>
                                
                                <div class="performance-card">
                                    <div class="info-tooltip">
                                        <i class="fas fa-info-circle"></i>
                                        <span class="tooltip-text">Average percentage difference between predictions and actual values</span>
                                    </div>
                                    <h4>Average Error</h4>
                                    <div class="metric-value" id="model-mape">--</div>
                                    <div class="metric-label">Mean % Error (MAPE)</div>
                                    <div class="metric-assessment" id="mape-assessment"></div>
                                </div>
                                
                                <div class="performance-card">
                                    <div class="info-tooltip">
                                        <i class="fas fa-info-circle"></i>
                                        <span class="tooltip-text">Average absolute difference between predictions and actual values, normalized to a 0-1 scale</span>
                                    </div>
                                    <h4>Absolute Error</h4>
                                    <div class="metric-value" id="model-mae">--</div>
                                    <div class="metric-label">Normalized MAE (0-1)</div>
                                    <div class="mae-scale">
                                        <div class="mae-marker" id="mae-marker" style="left: 0%"></div>
                                    </div>
                                    <div class="scale-labels">
                                        <span>0 (Perfect)</span>
                                        <span>0.5 (Average)</span>
                                        <span>1 (Poor)</span>
                                    </div>
                                    <div class="metric-assessment" id="mae-assessment"></div>
                                </div>
                                
                                <div class="performance-card">
                                    <div class="info-tooltip">
                                        <i class="fas fa-info-circle"></i>
                                        <span class="tooltip-text">Overall confidence in the model's predictions based on multiple factors</span>
                                    </div>
                                    <h4>Prediction Confidence</h4>
                                    <div class="metric-value" id="confidence-score">--</div>
                                    <div class="metric-label">Confidence Level</div>
                                    <div class="metric-assessment" id="confidence-assessment"></div>
                                </div>
                            </div>
                            
                            <div class="performance-visualizations">
                                <div class="importance-chart-container">
                                    <h4>Top Influencing Factors</h4>
                                    <p>Macroeconomic indicators with the greatest impact on this metric</p>
                                    <div class="chart-wrapper">
                                        <canvas id="importanceChart"></canvas>
                                    </div>
                                </div>
                                
                                <div class="validation-chart-container">
                                    <h4>Model Validation</h4>
                                    <p>Comparison of predicted vs. actual values on test data</p>
                                    <div class="chart-wrapper">
                                        <canvas id="validationChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Selection Criteria Explanation -->
                        <div class="selection-criteria-section">
                            <h4>Model Selection Criteria</h4>
                            <div class="criteria-explanation">
                                <div class="criteria-item">
                                    <span class="criteria-label">Accuracy (R¬≤):</span>
                                    <span class="criteria-weight">40%</span>
                                    <span class="criteria-description">How well the model explains data variance</span>
                                </div>
                                <div class="criteria-item">
                                    <span class="criteria-label">Error Rate (MAPE):</span>
                                    <span class="criteria-weight">30%</span>
                                    <span class="criteria-description">Average prediction error percentage</span>
                                </div>
                                <div class="criteria-item">
                                    <span class="criteria-label">Absolute Error (MAE):</span>
                                    <span class="criteria-weight">20%</span>
                                    <span class="criteria-description">Normalized absolute error</span>
                                </div>
                                <div class="criteria-item">
                                    <span class="criteria-label">Stability:</span>
                                    <span class="criteria-weight">10%</span>
                                    <span class="criteria-description">Consistency across validation folds</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload Data Tab -->
    <div class="tab-content" id="upload-tab" style="display: none;">
        <div class="container">
            <div class="sidebar">
                <h2>Upload Company Data</h2>
                <div class="upload-instructions">
                    <p>Upload your company's historical data to use with our prediction models.
                    The file must be a CSV with the following columns:</p>
                    <a href="/download-sample-template" class="download-link">
                        <i class="fas fa-download"></i> Download sample template
                    </a>
                </div>
                
                <div class="requirements-list">
                    <h3>Required Columns:</h3>
                    <ul>
                        <li>Date (in YYYY-MM-DD format)</li>
                    </ul>
                    <h3>Additional Columns:</h3>
                    <ul>
                        <li>Any numeric columns (e.g., Revenue, Profit, Risk_Score)</li>
                        <li>At least one numeric column is required</li>
                        <li>Each column will be treated as a metric to be predicted</li>
                    </ul>
                    <h3>Data Requirements:</h3>
                    <ul>
                        <li>At least 12 months of data</li>
                        <li>Dates must overlap with our macroeconomic data</li>
                        <li>No missing values in the numeric columns</li>
                    </ul>
                </div>
                
                <div class="upload-note">
                    <p>Only upload data up through 2024-12-31. The system will automatically generate predictions for 2025-2026.</p>
                </div>
            </div>
            
            <div class="main-content">
                <form id="upload-form" action="/upload-company-data" method="post" enctype="multipart/form-data">
                    <div class="form-group">
                        <div class="file-input-container">
                            <input type="file" id="company-data-file" name="company-data-file" accept=".csv" required>
                            <label for="company-data-file" class="file-input-label">
                                <i class="fas fa-upload"></i> Choose CSV File
                            </label>
                            <span id="file-name">No file selected</span>
                        </div>
                        
                        <button type="submit" class="action-button">
                            <i class="fas fa-cloud-upload-alt"></i> Upload and Generate Predictions
                        </button>
                    </div>
                </form>
                
                <div id="upload-status" class="status-message hidden">
                    <div class="loader"></div>
                    <p>Processing your data...</p>
                </div>
                
                <div id="upload-result" class="result-container hidden">
                    <!-- Results will be displayed here -->
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript for Multi-Model Functionality -->
    <script>
        // Global variables
        let macroChart;
        let companyChart;
        let currentMacroIndicator;
        let currentCompanyMetric;
        let macroSummaryData;
        let companySummaryData;

        // Global variables for multi-model system
        let currentModelComparisonData = null;
        let currentModelDetails = {};
        let modelComparisonChart = null;
        let errorComparisonChart = null;
        let importanceChart = null;
        let validationChart = null;

        // Function to format numbers with commas for thousands
        function formatNumber(num) {
            return num.toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        window.currentMacroIndicator = null;
        window.currentCompanyMetric = null;

        // Enhanced loadModelPerformance function for multi-model support
        function loadModelPerformance(metric) {
    const performanceContainer = document.getElementById('model-performance-container');
    if (performanceContainer.classList.contains('hidden')) {
        return;
    }
    
    // Prevent multiple simultaneous loads
    if (performanceContainer.classList.contains('loading')) {
        console.log('Already loading performance data, skipping...');
        return;
    }
    
    console.log(`Loading performance data for metric: ${metric}`);
    performanceContainer.classList.add('loading');
    
    // Set a timeout to remove loading state if requests take too long
    const loadingTimeout = setTimeout(() => {
        console.warn('Loading timeout reached, removing loading state');
        performanceContainer.classList.remove('loading');
    }, 10000); // 10 second timeout
    
    // Load model comparison data
    loadModelComparison(metric);
    
    // Load best model details
    loadBestModelDetails(metric);
    
    // Clear the timeout when loading is complete
    Promise.allSettled([
        fetch(`/model-comparison/${metric}`),
        fetch(`/best-model/${metric}`)
    ]).finally(() => {
        clearTimeout(loadingTimeout);
        // Ensure loading state is removed
        setTimeout(() => {
            performanceContainer.classList.remove('loading');
        }, 500); // Small delay to ensure all updates are complete
    });
}
function clearAllLoadingStates() {
    const performanceContainer = document.getElementById('model-performance-container');
    if (performanceContainer) {
        performanceContainer.classList.remove('loading');
    }
    
    // Also remove any lingering opacity or blur effects
    const allCharts = document.querySelectorAll('canvas');
    allCharts.forEach(canvas => {
        canvas.style.opacity = '1';
        canvas.style.filter = 'none';
    });
    
    console.log('All loading states cleared');
}
        function loadModelComparison(metric) {
    fetch(`/model-comparison/${metric}`)
        .then(response => response.json())
        .then(data => {
            console.log(`Received comparison data for ${metric}:`, data);
            
            if (data.success) {
                currentModelComparisonData = data;
                updateModelSelector(data);
                updateModelComparisonCharts(data);
                updateModelRankingTable(data);
                updateBestModelSummary(data);
                
                // IMPORTANT: Remove loading state after successful data load
                const performanceContainer = document.getElementById('model-performance-container');
                if (performanceContainer) {
                    performanceContainer.classList.remove('loading');
                }
            } else {
                console.warn('No comparison data available, falling back to single model');
                loadSingleModelFallback(metric);
            }
        })
        .catch(error => {
            console.error('Error loading model comparison:', error);
            // IMPORTANT: Remove loading state on error too
            const performanceContainer = document.getElementById('model-performance-container');
            if (performanceContainer) {
                performanceContainer.classList.remove('loading');
            }
            loadSingleModelFallback(metric);
        });
}

        function loadBestModelDetails(metric) {
    fetch(`/best-model/${metric}`)
        .then(response => response.json())
        .then(data => {
            console.log(`Received best model data for ${metric}:`, data);
            
            if (data.success) {
                updateDetailedPerformanceView(data);
            }
            
            // IMPORTANT: Remove loading state after both comparison and details are loaded
            const performanceContainer = document.getElementById('model-performance-container');
            if (performanceContainer) {
                performanceContainer.classList.remove('loading');
            }
        })
        .catch(error => {
            console.error('Error loading best model details:', error);
            // IMPORTANT: Remove loading state on error
            const performanceContainer = document.getElementById('model-performance-container');
            if (performanceContainer) {
                performanceContainer.classList.remove('loading');
            }
        });
}


        function updateModelSelector(comparisonData) {
            const selector = document.getElementById('model-selector');
            const badge = document.getElementById('selected-model-badge');
            
            // Clear existing options except "Best Model"
            selector.innerHTML = '<option value="best">Best Model (Recommended)</option>';
            
            // Add options for each available model
            if (comparisonData.comparison_data && comparisonData.comparison_data.model_names) {
                comparisonData.comparison_data.model_names.forEach(modelName => {
                    const option = document.createElement('option');
                    option.value = modelName;
                    option.textContent = modelName;
                    if (modelName === comparisonData.best_model) {
                        option.textContent += ' ‚≠ê';
                    }
                    selector.appendChild(option);
                });
            }
            
            // Update badge
            badge.textContent = comparisonData.best_model || 'Unknown';
            badge.className = 'model-badge best-model';
            
            // Add event listener for model selection changes
            selector.onchange = function() {
                const selectedModel = this.value;
                if (selectedModel === 'best') {
                    badge.textContent = comparisonData.best_model || 'Unknown';
                    badge.className = 'model-badge best-model';
                    loadSpecificModelDetails(window.currentCompanyMetric, comparisonData.best_model);
                } else {
                    badge.textContent = selectedModel;
                    badge.className = 'model-badge selected-model';
                    loadSpecificModelDetails(window.currentCompanyMetric, selectedModel);
                }
            };
        }

        function loadSpecificModelDetails(metric, modelName) {
            fetch(`/model-details/${metric}/${modelName}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateDetailedPerformanceViewForModel(data);
                    }
                })
                .catch(error => {
                    console.error(`Error loading details for ${modelName}:`, error);
                });
        }

        function updateModelComparisonCharts(comparisonData) {
            if (!comparisonData.comparison_data) return;
            
            const data = comparisonData.comparison_data;
            
            // Create Model Performance Comparison Chart
            createModelComparisonChart(data);
            
            // Create Error Comparison Chart
            createErrorComparisonChart(data);
        }

        function createModelComparisonChart(data) {
    const canvas = document.getElementById('modelComparisonChart');
    if (!canvas) return;
    
    try {
        // Destroy existing chart
        if (modelComparisonChart) {
            modelComparisonChart.destroy();
            modelComparisonChart = null;
        }
        
        const ctx = canvas.getContext('2d');
        
        // Color coding: best model gets a special color
        const colors = data.model_names.map((name, index) => {
            if (currentModelComparisonData && name === currentModelComparisonData.best_model) {
                return 'rgba(255, 215, 0, 0.8)'; // Gold for best model
            }
            const colorPalette = [
                'rgba(54, 162, 235, 0.8)',
                'rgba(255, 99, 132, 0.8)',
                'rgba(75, 192, 192, 0.8)',
                'rgba(153, 102, 255, 0.8)',
                'rgba(255, 159, 64, 0.8)',
                'rgba(199, 199, 199, 0.8)',
                'rgba(83, 102, 255, 0.8)',
                'rgba(255, 205, 86, 0.8)'
            ];
            return colorPalette[index % colorPalette.length];
        });
        
        modelComparisonChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.model_names,
                datasets: [{
                    label: 'R¬≤ Score',
                    data: data.r2_scores,
                    backgroundColor: colors,
                    borderColor: colors.map(color => color.replace('0.8', '1')),
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: {
                    duration: 1000,
                    onComplete: function() {
                        // Ensure loading state is removed when animation completes
                        setTimeout(() => {
                            const container = document.getElementById('model-performance-container');
                            if (container) {
                                container.classList.remove('loading');
                            }
                        }, 100);
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            afterLabel: function(context) {
                                const index = context.dataIndex;
                                const complexity = data.complexity_levels[index];
                                const description = data.descriptions[index];
                                return [`Complexity: ${complexity}`, `${description}`];
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 1,
                        title: {
                            display: true,
                            text: 'R¬≤ Score (Higher is Better)'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Model Type'
                        }
                    }
                }
            }
        });
        
        console.log('Model comparison chart created successfully');
        
    } catch (error) {
        console.error('Error creating model comparison chart:', error);
        // Clear loading state on error
        const container = document.getElementById('model-performance-container');
        if (container) {
            container.classList.remove('loading');
        }
    }
}
function resetModelPerformanceSection() {
    console.log('Resetting model performance section...');
    
    // Clear all loading states
    clearAllLoadingStates();
    
    // Destroy all existing charts
    if (modelComparisonChart) {
        modelComparisonChart.destroy();
        modelComparisonChart = null;
    }
    if (errorComparisonChart) {
        errorComparisonChart.destroy();
        errorComparisonChart = null;
    }
    if (importanceChart) {
        importanceChart.destroy();
        importanceChart = null;
    }
    if (validationChart) {
        validationChart.destroy();
        validationChart = null;
    }
    
    // Reset UI elements
    const selector = document.getElementById('model-selector');
    if (selector) {
        selector.innerHTML = '<option value="best">Best Model (Recommended)</option>';
    }
    
    const badge = document.getElementById('selected-model-badge');
    if (badge) {
        badge.textContent = '';
        badge.className = 'model-badge';
    }
    
    // Clear table
    const tbody = document.querySelector('#model-ranking-table tbody');
    if (tbody) {
        tbody.innerHTML = '';
    }
    
    console.log('Model performance section reset complete');
}


        function createErrorComparisonChart(data) {
            const canvas = document.getElementById('errorComparisonChart');
            if (!canvas) return;
            
            // Destroy existing chart
            if (errorComparisonChart) {
                errorComparisonChart.destroy();
            }
            
            const ctx = canvas.getContext('2d');
            
            // Color coding for error rates (lower is better)
            const colors = data.mape_scores.map((score, index) => {
                if (score < 10) return 'rgba(76, 175, 80, 0.8)'; // Green for low error
                if (score < 20) return 'rgba(255, 193, 7, 0.8)'; // Yellow for moderate error
                return 'rgba(244, 67, 54, 0.8)'; // Red for high error
            });
            
            errorComparisonChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.model_names,
                    datasets: [{
                        label: 'MAPE (%)',
                        data: data.mape_scores,
                        backgroundColor: colors,
                        borderColor: colors.map(color => color.replace('0.8', '1')),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `MAPE: ${context.parsed.y.toFixed(2)}%`;
                                },
                                afterLabel: function(context) {
                                    const score = context.parsed.y;
                                    let assessment;
                                    if (score < 5) assessment = 'Excellent';
                                    else if (score < 10) assessment = 'Very Good';
                                    else if (score < 20) assessment = 'Good';
                                    else if (score < 30) assessment = 'Moderate';
                                    else assessment = 'Poor';
                                    return `Assessment: ${assessment}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'MAPE % (Lower is Better)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Model Type'
                            }
                        }
                    }
                }
            });
        }

        function updateModelRankingTable(comparisonData) {
            const tbody = document.querySelector('#model-ranking-table tbody');
            if (!tbody || !comparisonData.comparison_data) return;
            
            tbody.innerHTML = ''; // Clear existing rows
            
            const data = comparisonData.comparison_data;
            
            // Create ranking data by combining all metrics
            const rankings = data.model_names.map((name, index) => ({
                model: name,
                r2: data.r2_scores[index],
                mape: data.mape_scores[index],
                composite: data.composite_scores[index],
                isBest: name === comparisonData.best_model
            }));
            
            // Sort by composite score
            rankings.sort((a, b) => b.composite - a.composite);
            
            // Create table rows
            rankings.forEach((ranking, index) => {
                const row = document.createElement('tr');
                if (ranking.isBest) {
                    row.classList.add('best-model-row');
                }
                row.innerHTML = `
                    <td>${index + 1}${ranking.isBest ? ' üèÜ' : ''}</td>
                    <td class="model-name">${ranking.model}${ranking.isBest ? ' <span class="best-badge">BEST</span>' : ''}</td>
                    <td class="metric-value">${ranking.r2.toFixed(3)}</td>
                    <td class="metric-value">${ranking.mape.toFixed(2)}%</td>
                    <td class="metric-value">${ranking.composite.toFixed(3)}</td>
                `;
                
                tbody.appendChild(row);
            });
        }

        function updateBestModelSummary(comparisonData) {
            const modelInfo = document.getElementById('best-model-info');
            const confidenceLevel = document.getElementById('confidence-level');
            
            if (!modelInfo) return;
            
            const bestModel = comparisonData.best_model || 'Unknown';
            
            // Find best model data
            let bestModelIndex = -1;
            if (comparisonData.comparison_data && comparisonData.comparison_data.model_names) {
                bestModelIndex = comparisonData.comparison_data.model_names.indexOf(bestModel);
            }
            
            let description = 'Selected for optimal performance';
            let confidence = 'Good';
            
            if (bestModelIndex >= 0 && comparisonData.comparison_data.descriptions) {
                description = comparisonData.comparison_data.descriptions[bestModelIndex];
            }
            
            // Update the display
            modelInfo.querySelector('.model-name').textContent = bestModel;
            modelInfo.querySelector('.model-description').textContent = description;
            
            if (confidenceLevel) {
                confidenceLevel.textContent = confidence;
                confidenceLevel.className = `confidence-value ${confidence.toLowerCase().replace(' ', '-')}`;
            }
        }

        function updateDetailedPerformanceView(bestModelData) {
    if (!bestModelData.performance) return;
    
    const perf = bestModelData.performance;
    
    // Update metric values
    document.getElementById('model-r2').textContent = (perf.r2 || 0).toFixed(3);
    document.getElementById('model-mape').textContent = (perf.mape || 0).toFixed(2) + '%';
    
    // Use normalized_mae for the 0-1 display
    const normalizedMAE = perf.normalized_mae || 0;
    document.getElementById('model-mae').textContent = normalizedMAE.toFixed(3);
    
    // Update assessments
    updateMetricAssessment('r2-assessment', perf.r2, 'r2');
    updateMetricAssessment('mape-assessment', perf.mape, 'mape');
    updateMetricAssessment('mae-assessment', normalizedMAE, 'mae');
    
    // Update confidence
    if (bestModelData.confidence_assessment) {
        const confidence = bestModelData.confidence_assessment;
        document.getElementById('confidence-score').textContent = confidence.level || 'Good';
        document.getElementById('confidence-assessment').textContent = confidence.description || '';
    }
    
    // Update MAE marker position
    if (normalizedMAE !== undefined) {
        const clampedMAE = Math.min(Math.max(normalizedMAE, 0), 1);
        const markerPosition = clampedMAE * 100;
        document.getElementById('mae-marker').style.left = `${markerPosition}%`;
    }
    
    // Update charts if available
    if (bestModelData.details) {
        if (bestModelData.details.feature_importance) {
            createImportanceChart(bestModelData.details.feature_importance);
        }
        
        if (bestModelData.details.test_actual && bestModelData.details.test_predicted) {
            createValidationChart(
                bestModelData.details.test_actual,
                bestModelData.details.test_predicted,
                bestModelData.details.test_dates
            );
        }
    }
}


        function updateDetailedPerformanceView(bestModelData) {
    if (!bestModelData.performance) return;
    
    const perf = bestModelData.performance;
    
    // Update metric values - FIXED MAE display
    document.getElementById('model-r2').textContent = (perf.r2 || 0).toFixed(3);
    document.getElementById('model-mape').textContent = (perf.mape || 0).toFixed(2) + '%';
    
    // Use normalized_mae instead of mae for the 0-1 display
    const normalizedMAE = perf.normalized_mae || perf.mae || 0;
    document.getElementById('model-mae').textContent = normalizedMAE.toFixed(3);
    
    // Update assessments
    updateMetricAssessment('r2-assessment', perf.r2, 'r2');
    updateMetricAssessment('mape-assessment', perf.mape, 'mape');
    updateMetricAssessment('mae-assessment', normalizedMAE, 'mae'); // Use normalized value
    
    // Update confidence
    if (bestModelData.confidence_assessment) {
        const confidence = bestModelData.confidence_assessment;
        document.getElementById('confidence-score').textContent = confidence.level || 'Good';
        document.getElementById('confidence-assessment').textContent = confidence.description || '';
    }
    
    // Update MAE marker position - FIXED calculation
    if (normalizedMAE !== undefined) {
        // Ensure the value is between 0 and 1
        const clampedMAE = Math.min(Math.max(normalizedMAE, 0), 1);
        const markerPosition = clampedMAE * 100;
        document.getElementById('mae-marker').style.left = `${markerPosition}%`;
    }
    
    // Update charts if available
    if (bestModelData.details) {
        if (bestModelData.details.feature_importance) {
            createImportanceChart(bestModelData.details.feature_importance);
        }
        
        if (bestModelData.details.test_actual && bestModelData.details.test_predicted) {
            createValidationChart(
                bestModelData.details.test_actual,
                bestModelData.details.test_predicted,
                bestModelData.details.test_dates
            );
        }
    }
}

// Also update the similar function for specific model details
function updateDetailedPerformanceViewForModel(modelData) {
    if (!modelData.details || !modelData.details.metrics) return;
    
    const metrics = modelData.details.metrics;
    
    // Update metric values - FIXED MAE display
    document.getElementById('model-r2').textContent = (metrics.r2 || 0).toFixed(3);
    document.getElementById('model-mape').textContent = (metrics.mape || 0).toFixed(2) + '%';
    
    // Use normalized_mae for display
    const normalizedMAE = metrics.normalized_mae || metrics.mae || 0;
    document.getElementById('model-mae').textContent = normalizedMAE.toFixed(3);
    
    // Update assessments
    updateMetricAssessment('r2-assessment', metrics.r2, 'r2');
    updateMetricAssessment('mape-assessment', metrics.mape, 'mape');
    updateMetricAssessment('mae-assessment', normalizedMAE, 'mae');
    
    // Update confidence based on performance
    let confidence = 'Moderate';
    if (metrics.r2 > 0.8 && metrics.mape < 10) confidence = 'High';
    else if (metrics.r2 > 0.6 && metrics.mape < 20) confidence = 'Good';
    
    document.getElementById('confidence-score').textContent = confidence;
    
    // Update MAE marker position
    if (normalizedMAE !== undefined) {
        const clampedMAE = Math.min(Math.max(normalizedMAE, 0), 1);
        const markerPosition = clampedMAE * 100;
        document.getElementById('mae-marker').style.left = `${markerPosition}%`;
    }
    
    // Update charts
    if (modelData.details.feature_importance) {
        createImportanceChart(modelData.details.feature_importance);
    }
    
    if (modelData.details.test_actual && modelData.details.test_predictions) {
        createValidationChart(
            modelData.details.test_actual,
            modelData.details.test_predictions,
            modelData.details.test_dates
        );
    }
}
        function updateMetricAssessment(elementId, value, metricType) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            let assessment = '';
            let className = '';
            
            switch (metricType) {
                case 'r2':
                    if (value > 0.9) { assessment = 'Excellent'; className = 'excellent'; }
                    else if (value > 0.8) { assessment = 'Very Good'; className = 'very-good'; }
                    else if (value > 0.6) { assessment = 'Good'; className = 'good'; }
                    else if (value > 0.4) { assessment = 'Moderate'; className = 'moderate'; }
                    else { assessment = 'Poor'; className = 'poor'; }
                    break;
                case 'mape':
                    if (value < 5) { assessment = 'Excellent'; className = 'excellent'; }
                    else if (value < 10) { assessment = 'Very Good'; className = 'very-good'; }
                    else if (value < 20) { assessment = 'Good'; className = 'good'; }
                    else if (value < 30) { assessment = 'Moderate'; className = 'moderate'; }
                    else { assessment = 'Poor'; className = 'poor'; }
                    break;
                case 'mae':
                    if (value < 0.05) { assessment = 'Excellent'; className = 'excellent'; }
                    else if (value < 0.1) { assessment = 'Very Good'; className = 'very-good'; }
                    else if (value < 0.2) { assessment = 'Good'; className = 'good'; }
                    else if (value < 0.3) { assessment = 'Moderate'; className = 'moderate'; }
                    else { assessment = 'Poor'; className = 'poor'; }
                    break;
            }
            
            element.textContent = assessment;
            element.className = `metric-assessment ${className}`;
        }

        function loadSingleModelFallback(metric) {
            // Fallback to existing single model performance loading
            fetch(`/model-performance/${metric}`)
                .then(response => response.json())
                .then(data => {
                    console.log('Loaded single model fallback data:', data);
                    
                    // Update the detailed view with single model data
                    document.getElementById('model-r2').textContent = (data.r2 || 0).toFixed(3);
                    document.getElementById('model-mape').textContent = (data.mape || 0).toFixed(2) + '%';
                    document.getElementById('model-mae').textContent = (data.mae || 0).toFixed(3);
                    
                    // Hide comparison dashboard and show detailed view
                    document.getElementById('model-comparison-dashboard').style.display = 'none';
                    document.getElementById('detailed-performance-view').style.display = 'block';
                    
                    // Update charts
                    if (data.feature_importance) {
                        createImportanceChart(data.feature_importance);
                    }
                    
                    if (data.test_actual && data.test_predicted) {
                        createValidationChart(data.test_actual, data.test_predicted, data.test_dates);
                    }
                    
                    // Remove loading state
                    const performanceContainer = document.getElementById('model-performance-container');
                    performanceContainer.classList.remove('loading');
                })
                .catch(error => {
                    console.error('Error in single model fallback:', error);
                    const performanceContainer = document.getElementById('model-performance-container');
                    performanceContainer.classList.remove('loading');
                });
        }

        // Function to create feature importance chart
        function createImportanceChart(featureImportance) {
            console.log("Creating importance chart with data:", featureImportance);
            
            try {
                const canvas = document.getElementById('importanceChart');
                if (!canvas) {
                    console.error('Importance chart canvas not found');
                    return;
                }
                
                // Clear any previous chart
                if (importanceChart) {
                    importanceChart.destroy();
                }
                
                const ctx = canvas.getContext('2d');
                
                // Validate feature importance data
                if (!featureImportance || typeof featureImportance !== 'object' || Object.keys(featureImportance).length === 0) {
                    console.warn('Invalid feature importance data, using fallback');
                    featureImportance = {
                        'PIB_US_Courants': 0.25,
                        'RNB_US_Courants': 0.20,
                        'RNB_Par_Habitant': 0.15,
                        'Taux_Interet': 0.12,
                        'Masse_Monetaire': 0.10
                    };
                }
                
                // Get top 5 features
                const features = Object.keys(featureImportance);
                const top5Features = features.slice(0, Math.min(5, features.length));
                const top5Values = top5Features.map(feature => featureImportance[feature] * 100);
                
                // Clean labels
                const cleanLabels = top5Features.map(feature => feature.replace(/_/g, ' '));
                
                importanceChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: cleanLabels,
                        datasets: [{
                            label: 'Importance (%)',
                            data: top5Values,
                            backgroundColor: [
                                'rgba(54, 162, 235, 0.8)',
                                'rgba(75, 192, 192, 0.8)',
                                'rgba(153, 102, 255, 0.8)',
                                'rgba(255, 159, 64, 0.8)',
                                'rgba(255, 99, 132, 0.8)'
                            ],
                            borderColor: [
                                'rgba(54, 162, 235, 1)',
                                'rgba(75, 192, 192, 1)',
                                'rgba(153, 102, 255, 1)',
                                'rgba(255, 159, 64, 1)',
                                'rgba(255, 99, 132, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `Importance: ${context.raw.toFixed(2)}%`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return value + '%';
                                    }
                                },
                                title: {
                                    display: true,
                                    text: 'Importance (%)'
                                }
                            }
                        }
                    }
                });
                
                console.log('Importance chart created successfully');
                
            } catch (error) {
                console.error('Error creating importance chart:', error);
            }
        }

        // Function to create validation scatter plot
        function createValidationChart(actualValues, predictedValues, dates) {
            try {
                const canvas = document.getElementById('validationChart');
                if (!canvas) {
                    console.error('Validation chart canvas not found');
                    return;
                }
                
                // Clear any previous chart
                if (validationChart) {
                    validationChart.destroy();
                }
                
                const ctx = canvas.getContext('2d');
                
                // Validate input data
                if (!Array.isArray(actualValues) || !Array.isArray(predictedValues) || 
                    actualValues.length === 0 || actualValues.length !== predictedValues.length) {
                    console.error('Invalid data for validation chart');
                    return;
                }
                
                // Ensure dates array exists and matches length
                let validDates = dates;
                if (!Array.isArray(dates) || dates.length !== actualValues.length) {
                    console.warn('Invalid dates array for validation chart, generating fallback dates');
                    validDates = Array.from({ length: actualValues.length }, (_, i) => `Data point ${i+1}`);
                }
                
                // Create scatter points
                const scatterData = actualValues.map((actual, i) => ({
                    x: actual,
                    y: predictedValues[i],
                    date: validDates[i]
                }));
                
                // Find min and max values for the perfect prediction line
                const allValues = [...actualValues, ...predictedValues];
                const min = Math.min(...allValues);
                const max = Math.max(...allValues);
                
                validationChart = new Chart(ctx, {
                    type: 'scatter',
                    data: {
                        datasets: [
                            {
                                label: 'Test Data Points',
                                data: scatterData,
                                backgroundColor: 'rgba(54, 162, 235, 0.6)',
                                borderColor: 'rgba(54, 162, 235, 1)',
                                borderWidth: 1,
                                pointRadius: 6,
                                pointHoverRadius: 8
                            },
                            {
                                label: 'Perfect Prediction',
                                data: [
                                    { x: min, y: min },
                                    { x: max, y: max }
                                ],
                                type: 'line',
                                borderColor: 'rgba(255, 99, 132, 1)',
                                borderWidth: 2,
                                pointRadius: 0,
                                fill: false
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        if (context.datasetIndex === 0) {
                                            const point = context.raw;
                                            return [
                                                `Date: ${point.date}`,
                                                `Actual: ${formatNumber(point.x)}`,
                                                `Predicted: ${formatNumber(point.y)}`,
                                                `Difference: ${formatNumber(point.y - point.x)}`
                                            ];
                                        } else {
                                            return 'Perfect prediction line';
                                        }
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                type: 'linear',
                                position: 'bottom',
                                title: {
                                    display: true,
                                    text: 'Actual Value'
                                },
                                ticks: {
                                    callback: function(value) {
                                        return formatNumber(value);
                                    }
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Predicted Value'
                                },
                                ticks: {
                                    callback: function(value) {
                                        return formatNumber(value);
                                    }
                                }
                            }
                        }
                    }
                });
                
                console.log('Validation chart created successfully');
            } catch (error) {
                console.error('Error creating validation chart:', error);
            }
        }

        // Function to load macroeconomic data and create/update chart
        function loadMacroChart(indicator) {
            currentMacroIndicator = indicator;
            window.currentMacroIndicator = indicator;
            
            fetch(`/macro-data/${indicator}`)
                .then(response => response.json())
                .then(data => {
                    const ctx = document.getElementById('macroChart').getContext('2d');
                    
                    // Prepare datasets with different colors for historical and predicted data
                    let datasets = [];
                    
                    // Find where predictions start
                    const predictedStartIndex = data.is_predicted.indexOf(true);
                    
                    if (predictedStartIndex !== -1) {
                        // Historical data
                        datasets.push({
                            label: 'Historical',
                            data: data.values.slice(0, predictedStartIndex),
                            borderColor: '#1e88e5',
                            backgroundColor: 'rgba(30, 136, 229, 0.1)',
                            pointRadius: 1,
                            borderWidth: 2
                        });
                        
                        // Create a separate segment just for predicted data
                        const predictedData = new Array(predictedStartIndex).fill(null);
                        predictedData.push(...data.values.slice(predictedStartIndex));
                        
                        datasets.push({
                            label: 'Predicted (2025-2026)',
                            data: predictedData,
                            borderColor: '#e53935',
                            backgroundColor: 'rgba(229, 57, 53, 0.1)',
                            pointRadius: 2,
                            borderWidth: 2,
                            borderDash: [5, 5],
                            spanGaps: true
                        });
                    } else {
                        // All historical data
                        datasets.push({
                            label: indicator.replace('_', ' '),
                            data: data.values,
                            borderColor: '#1e88e5',
                            backgroundColor: 'rgba(30, 136, 229, 0.1)',
                            pointRadius: 1,
                            borderWidth: 2
                        });
                    }
                    
                    // Destroy previous chart if it exists
                    if (macroChart) {
                        macroChart.destroy();
                    }
                    
                    // Create new chart
                    macroChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: data.dates,
                            datasets: datasets
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                title: {
                                    display: true,
                                    text: indicator.replace('_', ' '),
                                    font: {
                                        size: 18
                                    }
                                },
                                legend: {
                                    position: 'top'
                                },
                                tooltip: {
                                    mode: 'index',
                                    intersect: false
                                }
                            },
                            scales: {
                                x: {
                                    ticks: {
                                        maxRotation: 45,
                                        minRotation: 45
                                    }
                                },
                                y: {
                                    beginAtZero: false
                                }
                            }
                        }
                    });
                    
                    // Update the indicator title
                    document.getElementById('current-macro-indicator').textContent = indicator.replace('_', ' ');
                    
                    // Update summary if we have it
                    updateMacroSummary();
                });
        }

        // Function to load company data and create/update chart with multi-model integration
        function loadCompanyChart(metric) {
            currentCompanyMetric = metric;
            window.currentCompanyMetric = metric;
            
            fetch(`/company-data/${metric}`)
                .then(response => response.json())
                .then(data => {
                    const ctx = document.getElementById('companyChart').getContext('2d');
                    
                    // Prepare datasets with different colors for historical and predicted data
                    let datasets = [];
                    
                    // Find where predictions start
                    const predictedStartIndex = data.is_predicted.indexOf(true);
                    
                    if (predictedStartIndex !== -1) {
                        // Historical data
                        datasets.push({
                            label: 'Historical',
                            data: data.values.slice(0, predictedStartIndex),
                            borderColor: '#1e88e5',
                            backgroundColor: 'rgba(30, 136, 229, 0.1)',
                            pointRadius: 1,
                            borderWidth: 2
                        });
                        
                        // Create a separate segment just for predicted data
                        const predictedData = new Array(predictedStartIndex).fill(null);
                        predictedData.push(...data.values.slice(predictedStartIndex));
                        
                        datasets.push({
                            label: 'Predicted (2025-2026)',
                            data: predictedData,
                            borderColor: '#e53935',
                            backgroundColor: 'rgba(229, 57, 53, 0.1)',
                            pointRadius: 2,
                            borderWidth: 2,
                            borderDash: [5, 5],
                            spanGaps: true
                        });
                    } else {
                        // All historical data
                        datasets.push({
                            label: metric.replace('_', ' '),
                            data: data.values,
                            borderColor: '#1e88e5',
                            backgroundColor: 'rgba(30, 136, 229, 0.1)',
                            pointRadius: 1,
                            borderWidth: 2
                        });
                    }
                    
                    // Destroy previous chart if it exists
                    if (companyChart) {
                        companyChart.destroy();
                    }
                    
                    // Create new chart
                    companyChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: data.dates,
                            datasets: datasets
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                title: {
                                    display: true,
                                    text: metric.replace('_', ' '),
                                    font: {
                                        size: 18
                                    }
                                },
                                legend: {
                                    position: 'top'
                                },
                                tooltip: {
                                    mode: 'index',
                                    intersect: false
                                }
                            },
                            scales: {
                                x: {
                                    ticks: {
                                        maxRotation: 45,
                                        minRotation: 45
                                    }
                                },
                                y: {
                                    beginAtZero: false
                                }
                            }
                        }
                    });
                    
                    // Update the metric title
                    document.getElementById('current-company-metric').textContent = metric.replace('_', ' ');
                    
                    // Update summary if we have it
                    updateCompanySummary();
                    
                    // Load multi-model performance data for this metric
                    loadModelPerformance(metric);
                });
        }

        // Chat functionality
        function sendTabMessage() {
            const tabChatInput = document.querySelector('#tab-chat-input');
            if (!tabChatInput) return;
            
            const message = tabChatInput.value.trim();
            if (!message) return;
            
            // Add user message to chat
            const userMessageId = addTabMessageToChat(message, 'user');
            
            // Clear input
            tabChatInput.value = '';
            
            // Add "thinking" message
            const thinkingId = addTabMessageToChat('Analyzing financial data...', 'thinking');
            
            // Get current context from dashboard
            const context = {
                current_view: getCurrentTab(),
                current_indicator: window.currentMacroIndicator || null,
                current_metric: window.currentCompanyMetric || null
            };
            
            // Send query to server
            fetch('/api/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    query: message,
                    context: context
                }),
            })
            .then(response => response.json())
            .then(data => {
                // Remove thinking message
                removeTabMessage(thinkingId);
                
                // Add response to chat
                let responseHtml = data.response;
                
                // Add sources if available
                if (data.sources && data.sources.length > 0) {
                    responseHtml += `<div class="chat-sources">Sources: ${data.sources.join(', ')}</div>`;
                }
                
                addTabMessageToChat(responseHtml, 'system');
            })
            .catch(error => {
                // Remove thinking message
                removeTabMessage(thinkingId);
                
                // Add error message
                addTabMessageToChat('Sorry, I encountered an error processing your question. Please try again.', 'system');
            });
        }

        function addTabMessageToChat(message, type) {
            const tabChatMessages = document.querySelector('#tab-chat-messages');
            if (!tabChatMessages) return null;
            
            const messageId = 'tab-msg-' + Date.now();
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.id = messageId;
            messageDiv.innerHTML = `<div class="message-content">${message}</div>`;
            
            tabChatMessages.appendChild(messageDiv);
            tabChatMessages.scrollTop = tabChatMessages.scrollHeight;
            
            return messageId;
        }

        function removeTabMessage(messageId) {
            if (!messageId) return;
            const messageDiv = document.getElementById(messageId);
            if (messageDiv) {
                messageDiv.remove();
            }
        }

        function getCurrentTab() {
            const activeTabButton = document.querySelector('.tab-button.active');
            return activeTabButton ? activeTabButton.getAttribute('data-tab') : null;
        }

        // Function to load and display macro summary data
        function loadMacroSummary() {
            fetch('/macro-summary')
                .then(response => response.json())
                .then(data => {
                    macroSummaryData = data;
                    if (currentMacroIndicator) {
                        updateMacroSummary();
                    }
                });
        }

        // Function to load and display company summary data
        function loadCompanySummary() {
            fetch('/company-summary')
                .then(response => response.json())
                .then(data => {
                    companySummaryData = data;
                    if (currentCompanyMetric) {
                        updateCompanySummary();
                    }
                });
        }
    function updateCompanySummary() {
    if (!companySummaryData || !currentCompanyMetric) return;
    
    const summary = companySummaryData[currentCompanyMetric];
    if (!summary) return;
    
    const summaryContent = document.getElementById('company-summary-content');
    
    // Color for the percent change
    const changeColor = summary.change_percent >= 0 ? 'green' : 'red';
    const changeSymbol = summary.change_percent >= 0 ? '‚ñ≤' : '‚ñº';
    
    summaryContent.innerHTML = `
        <h3>2025-2026 Predictions</h3>
        <div class="summary-item">
            <span>Initial (2025):</span>
            <span>${formatNumber(summary.start)}</span>
        </div>
        <div class="summary-item">
            <span>Final (2026):</span>
            <span>${formatNumber(summary.end)}</span>
        </div>
        <div class="summary-item">
            <span>Change:</span>
            <span style="color: ${changeColor}">
                ${changeSymbol} ${formatNumber(summary.change_percent)}%
            </span>
        </div>
        <div class="summary-item">
            <span>Min:</span>
            <span>${formatNumber(summary.min)}</span>
        </div>
        <div class="summary-item">
            <span>Max:</span>
            <span>${formatNumber(summary.max)}</span>
        </div>
        <div class="summary-item">
            <span>Average:</span>
            <span>${formatNumber(summary.mean)}</span>
        </div>
    `;
}

        // Function to update the macro summary panel
        function updateMacroSummary() {
            if (!macroSummaryData || !currentMacroIndicator) return;
            
            const summary = macroSummaryData[currentMacroIndicator];
            if (!summary) return;
            
            const summaryContent = document.getElementById('macro-summary-content');
            
            // Color for the percent change
            const changeColor = summary.change_percent >= 0 ? 'green' : 'red';
            const changeSymbol = summary.change_percent >= 0 ? '‚ñ≤' : '‚ñº';
            
            summaryContent.innerHTML = `
                <h3>2025-2026 Predictions</h3>
                <div class="summary-item">
                    <span>Initial (2025):</span>
                    <span>${formatNumber(summary.start)}</span>
                </div>
                <div class="summary-item">
                    <span>Final (2026):</span>
                    <span>${formatNumber(summary.end)}</span>
                </div>
                <div class="summary-item">
                    <span>Change:</span>
                    <span style="color: ${changeColor}">
                        ${changeSymbol} ${formatNumber(summary.change_percent)}%
                    </span>
                </div>
                <div class="summary-item">
                    <span>Min:</span>
                    <span>${formatNumber(summary.min)}</span>
                </div>
                <div class="summary-item">
                    <span>Max:</span>
                    <span>${formatNumber(summary.max)}</span>
                </div>
                <div class="summary-item">
                    <span>Average:</span>
                    <span>${formatNumber(summary.mean)}</span>
                </div>
            `;
        }

        // Tab functionality
        function showTab(tabId) {
            // Hide all tab content
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => {
                content.style.display = 'none';
            });
            
            // Remove active class from all tab buttons
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => {
                button.classList.remove('active');
            });
            
            // Show the selected tab content and set active class on button
            document.getElementById(tabId).style.display = 'block';
            document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
        }

        // File upload handling
        function handleFileUpload() {
            const fileInput = document.getElementById('company-data-file');
            const fileNameDisplay = document.getElementById('file-name');
            const uploadForm = document.getElementById('upload-form');
            const uploadStatus = document.getElementById('upload-status');
            const uploadResult = document.getElementById('upload-result');
            
            if (fileInput) {
                fileInput.addEventListener('change', function() {
                    if (this.files && this.files[0]) {
                        const fileName = this.files[0].name;
                        fileNameDisplay.textContent = fileName;
                        
                        // Basic client-side validation
                        if (!fileName.toLowerCase().endsWith('.csv')) {
                            uploadResult.innerHTML = `
                                <div class="error-message">
                                    <strong>Error:</strong> The selected file is not a CSV file.
                                    Please select a valid CSV file.
                                </div>
                            `;
                            uploadResult.classList.remove('hidden');
                            this.value = '';
                            fileNameDisplay.textContent = 'No file selected';
                        } else {
                            uploadResult.classList.add('hidden');
                        }
                    } else {
                        fileNameDisplay.textContent = 'No file selected';
                    }
                });
            }
            
            if (uploadForm) {
                uploadForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    if (fileInput.files.length === 0) {
                        uploadResult.innerHTML = `
                            <div class="error-message">
                                <strong>Error:</strong> Please select a file to upload.
                            </div>
                        `;
                        uploadResult.classList.remove('hidden');
                        return;
                    }
                    
                    uploadStatus.classList.remove('hidden');
                    uploadResult.classList.add('hidden');
                    
                    const formData = new FormData(this);
                    
                    fetch('/upload-company-data', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        uploadStatus.classList.add('hidden');
                        
                        if (data.success) {
                            let metricsProcessed = '';
                            if (data.metrics_processed && data.metrics_processed.length > 0) {
                                metricsProcessed = `
                                    <div class="validation-item">
                                        <span>Metrics processed:</span>
                                        <span>${data.metrics_processed.join(', ')}</span>
                                    </div>
                                `;
                            }
                            
                            let performanceMetrics = '';
                            if (data.model_performance) {
                                performanceMetrics = `
                                    <div class="performance-summary">
                                        <h4>Model Performance ${data.multi_model_used ? '(Multi-Model System)' : ''}</h4>
                                        <div class="performance-grid">
                                `;
                                
                                for (const metric in data.model_performance) {
                                    const performance = data.model_performance[metric];
                                    const bestModel = performance.best_model || 'RandomForest';
                                    const r2Display = (performance.r2).toFixed(3);
                                    const mapeDisplay = (performance.mape).toFixed(2) + '%';
                                    
                                    performanceMetrics += `
                                        <div class="performance-summary-card">
                                            <div class="metric-name">${metric}</div>
                                            <div class="best-model-badge">${bestModel}</div>
                                            <div class="metrics-row">
                                                <div class="mini-metric">
                                                    <div class="mini-value">${r2Display}</div>
                                                    <div class="mini-label">R¬≤ Score</div>
                                                </div>
                                                <div class="mini-metric">
                                                    <div class="mini-value">${mapeDisplay}</div>
                                                    <div class="mini-label">Error %</div>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                }
                                
                                performanceMetrics += `
                                        </div>
                                        <p class="performance-note">View detailed model performance metrics in the Company Metrics tab</p>
                                    </div>
                                `;
                            }
                            
                            uploadResult.innerHTML = `
                                <div class="success-message">
                                    <strong>Success!</strong> Your company data has been uploaded and processed using our ${data.multi_model_used ? 'advanced multi-model system' : 'prediction system'}.
                                    Predictions for 2025-2026 have been generated.
                                </div>
                                <div class="validation-details">
                                    <h3>Data Summary:</h3>
                                    <div class="validation-item">
                                        <span>Records processed:</span>
                                        <span>${data.records_processed}</span>
                                    </div>
                                    <div class="validation-item">
                                        <span>Date range:</span>
                                        <span>${data.date_range}</span>
                                    </div>
                                    <div class="validation-item">
                                        <span>Predictions generated:</span>
                                        <span>${data.predictions_generated}</span>
                                    </div>
                                    ${metricsProcessed}
                                </div>
                                ${performanceMetrics}
                            `;
                            
                            // Reload the page to update metrics in the UI
                            setTimeout(() => {
                                window.location.reload();
                            }, 5000);

                        } else {
                            let errorDetails = '';
                            if (data.errors && data.errors.length > 0) {
                                errorDetails = '<ul>' + 
                                    data.errors.map(err => `<li>${err}</li>`).join('') + 
                                    '</ul>';
                            }
                            
                            uploadResult.innerHTML = `
                                <div class="error-message">
                                    <strong>Error:</strong> ${data.message}
                                    ${errorDetails}
                                </div>
                            `;
                        }
                        
                        uploadResult.classList.remove('hidden');
                    })
                    .catch(error => {
                        uploadStatus.classList.add('hidden');
                        uploadResult.innerHTML = `
                            <div class="error-message">
                                <strong>Error:</strong> An unexpected error occurred while processing your request.
                                Please try again later.
                            </div>
                        `;
                        uploadResult.classList.remove('hidden');
                        console.error('Error:', error);
                    });
                });
            }
        }
document.addEventListener('DOMContentLoaded', function() {
    // Add a global click handler to manually clear loading states if needed
    document.addEventListener('keydown', function(e) {
        // Press Ctrl+Shift+R to reset the model performance section
        if (e.ctrlKey && e.shiftKey && e.key === 'R') {
            e.preventDefault();
            console.log('Manual reset triggered');
            resetModelPerformanceSection();
        }
    });
    
    // Also add a button to manually clear loading states (for debugging)
    const performanceContainer = document.getElementById('model-performance-container');
    if (performanceContainer) {
        // Add a small debug button (you can remove this in production)
        const debugButton = document.createElement('button');
        debugButton.textContent = 'Clear Loading';
        debugButton.style.position = 'absolute';
        debugButton.style.top = '10px';
        debugButton.style.right = '10px';
        debugButton.style.zIndex = '1000';
        debugButton.style.padding = '5px';
        debugButton.style.fontSize = '12px';
        debugButton.style.backgroundColor = '#ff4444';
        debugButton.style.color = 'white';
        debugButton.style.border = 'none';
        debugButton.style.borderRadius = '3px';
        debugButton.style.cursor = 'pointer';
        debugButton.onclick = function() {
            clearAllLoadingStates();
            resetModelPerformanceSection();
        };
        
        performanceContainer.style.position = 'relative';
        performanceContainer.appendChild(debugButton);
    }
});
        // Event listeners and initialization
        document.addEventListener('DOMContentLoaded', function() {
            // Set up tabs
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    showTab(tabId);
                });
            });
            
            // Load data for each section
            loadMacroSummary();
            loadCompanySummary();
            
            // Add click event to macro indicators
            const indicators = document.querySelectorAll('.indicator-item');
            indicators.forEach(item => {
                item.addEventListener('click', function() {
                    indicators.forEach(i => i.classList.remove('active'));
                    this.classList.add('active');
                    
                    const indicator = this.getAttribute('data-indicator');
                    loadMacroChart(indicator);
                });
            });
            
            // Add click event to company metrics
            const companyItems = document.querySelectorAll('.company-item');
            companyItems.forEach(item => {
                item.addEventListener('click', function() {
                    companyItems.forEach(i => i.classList.remove('active'));
                    this.classList.add('active');
                    
                    const metric = this.getAttribute('data-metric');
                    loadCompanyChart(metric);
                });
            });
            
            // Model performance toggle
            const toggleBtn = document.getElementById('toggle-performance-btn');
            const container = document.getElementById('model-performance-container');
            const toggleText = document.getElementById('toggle-text');
            
            if (toggleBtn) {
                toggleBtn.addEventListener('click', function() {
                    if (container.classList.contains('hidden')) {
                        container.classList.remove('hidden');
                        toggleText.textContent = 'Hide Model Performance';
                        
                        if (window.currentCompanyMetric) {
                            loadModelPerformance(window.currentCompanyMetric);
                        }
                    } else {
                        container.classList.add('hidden');
                        toggleText.textContent = 'Show Model Performance';
                    }
                });
            }
            
            // View switching functionality
            const comparisonViewBtn = document.getElementById('comparison-view-btn');
            const detailedViewBtn = document.getElementById('detailed-view-btn');
            const comparisonDashboard = document.getElementById('model-comparison-dashboard');
            const detailedView = document.getElementById('detailed-performance-view');
            
            if (comparisonViewBtn && detailedViewBtn) {
                comparisonViewBtn.addEventListener('click', function() {
                    comparisonViewBtn.classList.add('active');
                    detailedViewBtn.classList.remove('active');
                    comparisonDashboard.style.display = 'block';
                    detailedView.style.display = 'none';
                });
                
                detailedViewBtn.addEventListener('click', function() {
                    detailedViewBtn.classList.add('active');
                    comparisonViewBtn.classList.remove('active');
                    comparisonDashboard.style.display = 'none';
                    detailedView.style.display = 'block';
                });
            }
            
            // Chat functionality
            const sendButton = document.querySelector('#tab-send-chat-btn');
            const chatInput = document.querySelector('#tab-chat-input');
            
            if (sendButton) {
                sendButton.addEventListener('click', sendTabMessage);
            }
            
            if (chatInput) {
                chatInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        sendTabMessage();
                    }
                });
            }
            
            // File upload handling
            handleFileUpload();
            
            // If indicators exist, select the first one by default
            if (indicators.length > 0) {
                indicators[0].click();
            }
            
            // If company metrics exist, select the first one by default
            if (companyItems.length > 0) {
                companyItems[0].click();
            }
            
            // Set the first tab as active
            showTab('macro-tab');
        });
    </script>
    
    <style>
        /* Additional styles for upload result enhancements */
        .performance-summary {
            margin-top: 20px;
            background-color: #f0f4ff;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #3f51b5;
        }
        
        .performance-summary h4 {
            color: #3f51b5;
            margin-bottom: 15px;
        }
        
        .performance-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .performance-summary-card {
            background: white;
            padding: 12px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .metric-name {
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
            text-align: center;
        }
        
        .best-model-badge {
            background-color: #ffd700;
            color: #333;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: bold;
            text-transform: uppercase;
            text-align: center;
            margin-bottom: 10px;
        }
        
        .metrics-row {
            display: flex;
            justify-content: space-around;
        }
        
        .mini-metric {
            text-align: center;
        }
        
        .mini-value {
            font-size: 18px;
            font-weight: bold;
            color: #3f51b5;
        }
        
        .mini-label {
            font-size: 12px;
            color: #666;
        }
        
        .performance-note {
            font-size: 0.85rem;
            color: #666;
            margin-top: 15px;
            font-style: italic;
            text-align: center;
        }
    </style>
</body>
</html>
